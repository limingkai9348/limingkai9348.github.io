<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="宝宝识物">
<meta name="viewport"
  content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>选择图包</title>

<style>
body {
  margin: 0;
  background: #f7f7f7;
  font-family: -apple-system, BlinkMacSystemFont;
}
h1 {
  text-align: center;
  padding: 16px 0;
}
.item {
  background: #fff;
  margin: 12px 16px;
  padding: 20px;
  font-size: 24px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.cache-control {
  background: #fff;
  margin: 12px 16px;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.cache-control summary {
  font-size: 18px;
  font-weight: normal;
  cursor: pointer;
  padding: 4px 0;
  user-select: none;
  list-style: none;
}
.cache-control summary::-webkit-details-marker {
  display: none;
}
.cache-control summary::before {
  content: '▶ ';
  display: inline-block;
  transition: transform 0.2s;
  margin-right: 4px;
}
.cache-control[open] summary::before {
  transform: rotate(90deg);
}
.cache-control-content {
  margin-top: 12px;
}
.cache-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
}
.switch-label {
  font-size: 16px;
  color: #333;
}
.switch {
  position: relative;
  width: 50px;
  height: 28px;
  background: #ccc;
  border-radius: 14px;
  cursor: pointer;
  transition: background 0.3s;
}
.switch.active {
  background: #4CAF50;
}
.switch::after {
  content: '';
  position: absolute;
  width: 24px;
  height: 24px;
  background: #fff;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: left 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.switch.active::after {
  left: 24px;
}
.cache-button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  background: #2196F3;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}
.cache-button:hover {
  background: #1976D2;
}
.cache-button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
.cache-progress {
  margin-top: 12px;
  font-size: 14px;
  color: #666;
  text-align: center;
}
.cache-status {
  margin-top: 8px;
  font-size: 12px;
  color: #999;
  text-align: center;
}
</style>
</head>

<body>


<h1>宝宝识物</h1>
<div id="list"></div>

<div class="cache-control">
  <details>
    <summary>缓存设置</summary>
    <div class="cache-control-content">
      <div class="cache-switch">
        <span class="switch-label">缓存优先模式</span>
        <div class="switch" id="cacheSwitch"></div>
      </div>
      <div class="cache-switch">
        <span class="switch-label">强制缓存（即使文件存在也重新缓存）</span>
        <div class="switch" id="forceCacheSwitch"></div>
      </div>
      <button class="cache-button" id="cacheButton">手动缓存所有资源</button>
      <div class="cache-progress" id="cacheProgress"></div>
      <div class="cache-status" id="cacheStatus"></div>
    </div>
  </details>
</div>



<script>
// 注册 Service Worker（缓存功能）
let serviceWorkerRegistration = null;
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    serviceWorkerRegistration = reg;
    updateCacheStatus();
  });
}

// 缓存控制相关元素
const cacheSwitch = document.getElementById('cacheSwitch');
const forceCacheSwitch = document.getElementById('forceCacheSwitch');
const cacheButton = document.getElementById('cacheButton');
const cacheProgress = document.getElementById('cacheProgress');
const cacheStatus = document.getElementById('cacheStatus');

// 加载缓存优先开关状态
const cacheFirstMode = localStorage.getItem('cacheFirstMode') === 'true';
if (cacheFirstMode) {
  cacheSwitch.classList.add('active');
}

// 加载强制缓存开关状态
const forceCacheMode = localStorage.getItem('forceCacheMode') === 'true';
if (forceCacheMode) {
  forceCacheSwitch.classList.add('active');
}

// 切换强制缓存模式
forceCacheSwitch.onclick = () => {
  const isActive = forceCacheSwitch.classList.toggle('active');
  localStorage.setItem('forceCacheMode', isActive);
};

// 切换缓存优先模式
cacheSwitch.onclick = () => {
  const isActive = cacheSwitch.classList.toggle('active');
  localStorage.setItem('cacheFirstMode', isActive);
  
  // 通知 Service Worker 更新策略
  if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
    serviceWorkerRegistration.active.postMessage({
      type: 'updateCacheStrategy',
      cacheFirst: isActive
    });
  }
  
  updateCacheStatus();
};

// 手动缓存所有资源
cacheButton.onclick = async () => {
  if (cacheButton.disabled) return;
  
  cacheButton.disabled = true;
  cacheProgress.textContent = '正在收集资源列表...';
  cacheStatus.textContent = '';
  
  try {
    // 收集所有资源
    const packsResponse = await fetch('data/packs.json');
    const packs = await packsResponse.json();
    const resources = new Set();
    
    // 添加 packs.json 本身
    resources.add('data/packs.json');
    
    for (const pack of packs) {
      // 添加每个 pack 的 JSON 文件
      resources.add(`data/${pack.id}.json`);
      
      const packResponse = await fetch(`data/${pack.id}.json`);
      const cards = await packResponse.json();
      cards.forEach(card => {
        if (card.image) resources.add(card.image);
        if (card.audio) resources.add(card.audio);
      });
    }
    
    const resourceList = Array.from(resources);
    cacheProgress.textContent = `找到 ${resourceList.length} 个资源，开始缓存...`;
    
    // 发送缓存请求到 Service Worker
    if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
      // 监听 Service Worker 的响应
      const messageHandler = (event) => {
        const data = event.data;
        if (data.type === 'cacheProgress') {
          const { current, total, url } = data;
          cacheProgress.textContent = `正在缓存: ${current}/${total} (${Math.round(current/total*100)}%)`;
          if (url) {
            cacheStatus.textContent = `当前: ${url.split('/').pop()}`;
          }
        } else if (data.type === 'cacheComplete') {
          const { success, failed, skipped, updated, total } = data;
          let statusText = `缓存完成！成功: ${success}, 失败: ${failed}, 总计: ${total}`;
          if (skipped > 0) {
            statusText += `, 已跳过: ${skipped}`;
          }
          if (updated > 0) {
            statusText += `, 已更新: ${updated}`;
          }
          cacheProgress.textContent = statusText;
          cacheStatus.textContent = '';
          cacheButton.disabled = false;
          navigator.serviceWorker.removeEventListener('message', messageHandler);
          updateCacheStatus();
        } else if (data.type === 'cacheError') {
          cacheProgress.textContent = `缓存出错: ${data.error}`;
          cacheButton.disabled = false;
          navigator.serviceWorker.removeEventListener('message', messageHandler);
        }
      };
      
      navigator.serviceWorker.addEventListener('message', messageHandler);
      
      // 获取强制缓存状态
      const forceUpdate = forceCacheSwitch.classList.contains('active');
      
      // 发送缓存请求
      serviceWorkerRegistration.active.postMessage({
        type: 'cacheResources',
        resources: resourceList,
        forceUpdate: forceUpdate
      });
    } else {
      cacheProgress.textContent = 'Service Worker 未就绪，请刷新页面后重试';
      cacheButton.disabled = false;
    }
  } catch (error) {
    cacheProgress.textContent = `错误: ${error.message}`;
    cacheButton.disabled = false;
  }
};

// 更新缓存状态显示
async function updateCacheStatus() {
  if (!('caches' in window)) {
    cacheStatus.textContent = '浏览器不支持缓存';
    return;
  }
  
  try {
    const cache = await caches.open('baby-cards-v6');
    const keys = await cache.keys();
    const imageCount = keys.filter(k => k.url.match(/\.(jpg|jpeg|png|gif|webp)$/i)).length;
    const audioCount = keys.filter(k => k.url.match(/\.mp3$/i)).length;
    const jsonCount = keys.filter(k => k.url.match(/\.json$/i)).length;
    const mode = cacheSwitch.classList.contains('active') ? '缓存优先' : '网络优先';
    cacheStatus.textContent = `已缓存: ${imageCount} 图片, ${audioCount} 音频, ${jsonCount} JSON | 模式: ${mode}`;
  } catch (error) {
    cacheStatus.textContent = '无法读取缓存状态';
  }
}

// 加载图包列表
fetch('data/packs.json')
  .then(r => r.json())
  .then(packs => {
    const root = document.getElementById('list');
    packs.forEach(p => {
      const div = document.createElement('div');
      div.className = 'item';
      div.textContent = p.title;
      div.onclick = () => {
        // 如果图包id为music，跳转到music-list.html，否则跳转到list.html
        if (p.id === 'music') {
          location.href = `music-list.html?pack=${p.id}`;
        } else {
          location.href = `list.html?pack=${p.id}`;
        }
      };
      root.appendChild(div);
    });
  });

// 定期更新缓存状态
setInterval(updateCacheStatus, 5000);
</script>

</body>
</html>